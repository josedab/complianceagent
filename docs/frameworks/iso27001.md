# ISO 27001 Compliance Guide

This guide covers how ComplianceAgent helps you achieve and maintain compliance with ISO/IEC 27001 Information Security Management System (ISMS).

## Overview

| Attribute | Value |
|-----------|-------|
| **Full Name** | ISO/IEC 27001:2022 Information Security Management |
| **Jurisdiction** | International |
| **Developed By** | ISO/IEC Joint Technical Committee |
| **Certification** | Third-party audit required |
| **Recertification** | Every 3 years with annual surveillance |

## Structure

ISO 27001 consists of:

1. **Clauses 4-10**: Management system requirements
2. **Annex A**: 93 security controls (ISO 27001:2022)

### Management System Clauses

| Clause | Title | Focus |
|--------|-------|-------|
| 4 | Context of the Organization | Scope, stakeholders, ISMS boundaries |
| 5 | Leadership | Management commitment, policy, roles |
| 6 | Planning | Risk assessment, objectives, planning |
| 7 | Support | Resources, competence, awareness, communication |
| 8 | Operation | Risk treatment, operational planning |
| 9 | Performance Evaluation | Monitoring, internal audit, management review |
| 10 | Improvement | Nonconformity, corrective action, continual improvement |

### Annex A Control Categories (ISO 27001:2022)

| Category | Controls | Description |
|----------|----------|-------------|
| **Organizational** | 37 | Policies, roles, asset management, access control |
| **People** | 8 | Screening, training, disciplinary, termination |
| **Physical** | 14 | Secure areas, equipment, clear desk |
| **Technological** | 34 | Endpoint, network, application, cryptography |

## Key Controls for Development

### A.8 Technological Controls

| Control | Title | Code Impact |
|---------|-------|-------------|
| A.8.2 | Privileged access rights | Admin role separation, least privilege |
| A.8.3 | Information access restriction | Authorization checks, data classification |
| A.8.4 | Access to source code | Repository access controls |
| A.8.9 | Configuration management | Version control, change tracking |
| A.8.12 | Data leakage prevention | Output validation, logging |
| A.8.24 | Use of cryptography | Encryption standards, key management |
| A.8.25 | Secure development lifecycle | Security testing, code review |
| A.8.26 | Application security requirements | Security requirements in design |
| A.8.27 | Secure system architecture | Defense in depth, segmentation |
| A.8.28 | Secure coding | Input validation, output encoding |

## ComplianceAgent Detection

### Automatically Detected Issues

```
ISO27001-001: Missing access control implementation
ISO27001-002: Inadequate cryptographic protection
ISO27001-003: Missing audit logging
ISO27001-004: Insecure configuration management
ISO27001-005: Missing input validation
ISO27001-006: Hardcoded secrets or credentials
ISO27001-007: Insufficient error handling
ISO27001-008: Missing secure session management
ISO27001-009: Inadequate data classification handling
ISO27001-010: Missing change management documentation
```

### Example Detection

**Issue: ISO27001-002 - Inadequate cryptographic protection**

```python
# ❌ Non-compliant: Weak encryption algorithm
import hashlib

def hash_password(password: str) -> str:
    # MD5 is cryptographically broken
    return hashlib.md5(password.encode()).hexdigest()

def encrypt_data(data: str, key: str) -> bytes:
    # DES is deprecated and insecure
    from Crypto.Cipher import DES
    cipher = DES.new(key.encode(), DES.MODE_ECB)
    return cipher.encrypt(data.encode())
```

**ComplianceAgent Fix:**

```python
# ✅ Compliant: Strong cryptographic algorithms (A.8.24)
from passlib.hash import argon2
from cryptography.fernet import Fernet
from cryptography.hazmat.primitives.ciphers.aead import AESGCM
import secrets

def hash_password(password: str) -> str:
    """Hash password using Argon2id (OWASP recommended)."""
    return argon2.hash(password)

def verify_password(password: str, hash: str) -> bool:
    """Verify password against stored hash."""
    return argon2.verify(password, hash)

def encrypt_data(data: bytes, key: bytes) -> bytes:
    """Encrypt data using AES-256-GCM with authentication."""
    # A.8.24: Use authenticated encryption
    aesgcm = AESGCM(key)
    nonce = secrets.token_bytes(12)
    ciphertext = aesgcm.encrypt(nonce, data, None)
    return nonce + ciphertext
```

**Issue: ISO27001-005 - Missing input validation**

```python
# ❌ Non-compliant: No input validation
@app.post("/api/users")
async def create_user(data: dict):
    # Direct use of unvalidated input
    user = User(**data)
    db.add(user)
    return user
```

**ComplianceAgent Fix:**

```python
# ✅ Compliant: Comprehensive input validation (A.8.28)
from pydantic import BaseModel, EmailStr, Field, validator
import re

class UserCreate(BaseModel):
    """User creation schema with validation."""
    
    email: EmailStr
    name: str = Field(..., min_length=1, max_length=100)
    password: str = Field(..., min_length=12, max_length=128)
    
    @validator("name")
    def validate_name(cls, v):
        # A.8.28: Sanitize input to prevent injection
        if not re.match(r"^[\w\s\-\.]+$", v):
            raise ValueError("Name contains invalid characters")
        return v.strip()
    
    @validator("password")
    def validate_password(cls, v):
        # A.8.24: Enforce password complexity
        if not re.search(r"[A-Z]", v):
            raise ValueError("Password must contain uppercase letter")
        if not re.search(r"[a-z]", v):
            raise ValueError("Password must contain lowercase letter")
        if not re.search(r"\d", v):
            raise ValueError("Password must contain digit")
        if not re.search(r"[!@#$%^&*]", v):
            raise ValueError("Password must contain special character")
        return v

@app.post("/api/users")
async def create_user(data: UserCreate):
    # Validated input through Pydantic schema
    user = User(
        email=data.email,
        name=data.name,
        password_hash=hash_password(data.password),
    )
    db.add(user)
    return user
```

**Issue: ISO27001-008 - Insecure session management**

```python
# ❌ Non-compliant: Weak session configuration
from fastapi import FastAPI
from starlette.middleware.sessions import SessionMiddleware

app = FastAPI()
app.add_middleware(
    SessionMiddleware,
    secret_key="simple-secret",  # Weak secret
    # Missing secure flags
)
```

**ComplianceAgent Fix:**

```python
# ✅ Compliant: Secure session management (A.8.28)
import os
from fastapi import FastAPI
from starlette.middleware.sessions import SessionMiddleware

app = FastAPI()

# A.8.24: Use cryptographically secure secret
SESSION_SECRET = os.environ.get("SESSION_SECRET")
if not SESSION_SECRET or len(SESSION_SECRET) < 32:
    raise ValueError("SESSION_SECRET must be at least 32 characters")

app.add_middleware(
    SessionMiddleware,
    secret_key=SESSION_SECRET,
    session_cookie="__Host-session",  # Host-prefix for security
    max_age=3600,  # 1 hour expiration
    same_site="strict",  # CSRF protection
    https_only=True,  # Require HTTPS
)
```

## Risk Assessment Integration

ComplianceAgent helps with ISO 27001 risk assessment:

```python
# Risk assessment API integration
from complianceagent import RiskAssessment

assessment = RiskAssessment(framework="ISO27001")

# Identify risks from codebase scan
risks = assessment.scan_codebase("/path/to/repo")

for risk in risks:
    print(f"""
    Asset: {risk.asset}
    Threat: {risk.threat}
    Vulnerability: {risk.vulnerability}
    Likelihood: {risk.likelihood}/5
    Impact: {risk.impact}/5
    Risk Level: {risk.risk_level}
    Controls: {risk.suggested_controls}
    """)
```

## Statement of Applicability (SoA)

ComplianceAgent generates SoA documentation:

```bash
# Generate Statement of Applicability
complianceagent report generate \
  --framework iso27001 \
  --report-type soa \
  --output soa.pdf

# Include control justifications
complianceagent soa export \
  --include-justifications \
  --include-evidence \
  --format xlsx
```

## Control Implementation Status

```
Dashboard → Compliance → ISO 27001 → Controls

┌─────────────────────────────────────────────────────────┐
│ A.8.24 Use of Cryptography                              │
├─────────────────────────────────────────────────────────┤
│ Status: ✅ Implemented                                  │
│ Implementation:                                         │
│   - AES-256-GCM for data encryption                    │
│   - Argon2id for password hashing                      │
│   - TLS 1.3 for data in transit                        │
│ Evidence:                                               │
│   - backend/app/core/crypto.py                         │
│   - backend/app/core/security.py                       │
│ Last Review: 2024-01-15                                │
│ Next Review: 2024-04-15                                │
└─────────────────────────────────────────────────────────┘
```

## SDK Integration

```python
from complianceagent import configure, audit_log, encrypt_pii

configure(regulations=["ISO27001"])

# A.8.3: Information access restriction
@access_control(classification="confidential")
async def get_financial_report(report_id: str):
    return await db.reports.get(report_id)

# A.8.12: Data leakage prevention
@audit_log(action="data_export", classification="restricted")
async def export_customer_data(customer_id: str):
    return await db.customers.export(customer_id)

# A.8.24: Use of cryptography
@encrypt_pii(fields=["ssn", "tax_id"])
async def store_employee(employee: EmployeeCreate):
    return await db.employees.create(employee)
```

## Continuous Compliance

### Automated Monitoring

```yaml
# .github/workflows/iso27001-compliance.yml
name: ISO 27001 Compliance Check

on:
  push:
    branches: [main]
  pull_request:
  schedule:
    - cron: '0 0 * * *'  # Daily

jobs:
  compliance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run ISO 27001 compliance scan
        uses: complianceagent/action@v1
        with:
          framework: iso27001
          fail-on: high
          
      - name: Upload evidence
        run: complianceagent evidence upload --framework iso27001
```

### Internal Audit Support

```bash
# Prepare for internal audit (Clause 9.2)
complianceagent audit prepare \
  --framework iso27001 \
  --scope "development-controls" \
  --output audit-package/

# Contents:
# - Control implementation evidence
# - Risk assessment results
# - Nonconformity register
# - Previous audit findings status
```

## Best Practices

### 1. Defense in Depth (A.8.27)

```python
# Multiple security layers
@require_authentication
@require_mfa
@require_role("financial_analyst")
@check_data_classification("confidential")
@rate_limit(requests=10, window=60)
@audit_log("financial_data_access")
async def view_financial_data():
    pass
```

### 2. Secure Development Lifecycle (A.8.25)

```
Planning → Design Review → Implementation → Code Review → Testing → Deployment
    ↓           ↓              ↓              ↓           ↓          ↓
Security    Threat         Static        Peer       DAST/      Security
Reqs      Modeling        Analysis      Review     Pentest    Monitoring
```

### 3. Change Management (A.8.9)

```python
# All changes tracked and approved
@require_change_request
@require_approval(approvers=["security_team"])
@audit_log("configuration_change")
async def update_security_config(config: SecurityConfig):
    # Change is logged with full context
    pass
```

## Resources

- [ISO 27001:2022 Standard](https://www.iso.org/standard/27001)
- [ISO 27002:2022 Controls](https://www.iso.org/standard/75652.html)
- [Implementation Guide](https://www.iso.org/publication/PUB100437.html)

## Related Documentation

- [Security Best Practices](../guides/security.md)
- [SOC 2 Compliance](soc2.md)
- [Audit Trail Feature](../features/audit-trail.md)
